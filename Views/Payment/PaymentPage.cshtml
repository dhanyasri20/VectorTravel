@{
    ViewData["Title"] = "Complete Your Payment";
    var currentUser = ViewBag.CurrentUser;
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header text-center">
                    <h3>Finalizing Your Payment</h3>
                </div>
                <div class="card-body">
                    <p class="text-muted">Please provide the passenger's name and complete the secure payment.</p>

                    <div class="mb-3">
                        <label for="passengerName" class="form-label fw-bold">Passenger Full Name</label>
                        <input type="text" id="passengerName" class="form-control form-control-lg" placeholder="Enter full name" required />
                    </div>

                    <div class="d-grid">
                        <button id="rzp-button1" class="btn btn-success btn-lg">Pay Securely</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>


<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var options = {
            "key": "@ViewBag.KeyId",
            "amount": "@ViewBag.Amount", // Amount is in currency subunits. Default currency is INR.
            "currency": "@ViewBag.Currency",
            "name": "@ViewBag.Name",
            "description": "@ViewBag.Description",
            "order_id": "@ViewBag.OrderId",
            "handler": function (response) {
                // Get the passenger name from the input field
                var passengerNameValue = document.getElementById('passengerName').value;

                var data = {
                    flightId: "@ViewBag.FlightId",
                    selectedSeat: "@ViewBag.SelectedSeat",
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_signature: response.razorpay_signature,
                    passengerName: passengerNameValue // <-- The passenger name is now included
                };

                // Send the verification data to your controller
                $.ajax({
                    url: '/Payment/VerifyPayment',
                    type: 'POST',
                    data: data,
                    success: function (res) {
                        // On success, redirect to a confirmation page
                        window.location.href = '/Bookings/Confirmation';
                    },
                    error: function (err) {
                        // On failure, show an alert
                        alert("Payment verification failed. Please contact support.");
                        console.error(err);
                    }
                });
            },
            "prefill": {
                "name": "@currentUser.FirstName @currentUser.LastName",
                "email": "@currentUser.Email",
                "contact": "@currentUser.PhoneNumber"
            },
            "theme": {
                "color": "#3399cc"
            }
        };

        var rzp = new Razorpay(options);

        // Bind the click event to your button
        document.getElementById('rzp-button1').onclick = function (e) {
            // Check if passenger name is filled
            var passengerNameInput = document.getElementById('passengerName');
            if (!passengerNameInput.value) {
                alert('Please enter the passenger name.');
                passengerNameInput.focus();
                e.preventDefault();
                return;
            }
            rzp.open();
            e.preventDefault();
        }
    });
</script> 